# æ— å¤´æµè§ˆå™¨ä¸æµè§ˆå™¨ç‰¹å¾

æœ€è¿‘å®‰å…¨è¿™å—åœ¨åšæ— å¤´æµè§ˆå™¨çš„æ£€æµ‹ï¼Œå¹¶ä¸”ä¹‹å‰ä¹Ÿæœ‰åŒå­¦é‡åˆ°è¿‡éœ€è¦åˆ¤æ–­ç”¨æˆ·ç‰¹å¾çš„å”¯ä¸€æ€§é—®é¢˜ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹

## æ— å¤´æµè§ˆå™¨ä»‹ç»

æ— å¤´æµè§ˆå™¨æŒ‡çš„æ˜¯æ²¡æœ‰å›¾å½¢ç”¨æˆ·ç•Œé¢çš„æµè§ˆå™¨ã€‚

[wiki](https://zh.wikipedia.org/wiki/%E6%97%A0%E5%A4%B4%E6%B5%8F%E8%A7%88%E5%99%A8): æ— å¤´æµè§ˆå™¨åœ¨ç±»ä¼¼äºæµè¡Œç½‘ç»œæµè§ˆå™¨çš„ç¯å¢ƒä¸­æä¾›å¯¹ç½‘é¡µçš„è‡ªåŠ¨æ§åˆ¶ï¼Œä½†æ˜¯é€šè¿‡å‘½ä»¤è¡Œç•Œé¢æˆ–ä½¿ç”¨ç½‘ç»œé€šä¿¡æ¥æ‰§è¡Œã€‚ å®ƒä»¬å¯¹äºæµ‹è¯•ç½‘é¡µç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬èƒ½å¤Ÿåƒæµè§ˆå™¨ä¸€æ ·å‘ˆç°å’Œç†è§£è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼ŒåŒ…æ‹¬é¡µé¢å¸ƒå±€ã€é¢œè‰²ã€å­—ä½“é€‰æ‹©ä»¥åŠ JavaScript å’Œ AJAX çš„æ‰§è¡Œç­‰æ ·å¼å…ƒç´ ï¼Œè¿™äº›å…ƒç´ åœ¨ä½¿ç”¨å…¶ä»–æµ‹è¯•æ–¹æ³•æ—¶é€šå¸¸æ˜¯ä¸å¯ç”¨çš„ã€‚

æ— å¤´æµè§ˆå™¨é€šå¸¸ç”¨æ¥ï¼š

1. Web åº”ç”¨ç¨‹åºä¸­çš„æµ‹è¯•è‡ªåŠ¨åŒ–ã€‚
2. æ‹æ‘„ç½‘é¡µæˆªå›¾
3. å¯¹ JavaScript åº“è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
4. æ”¶é›†ç½‘ç«™æ•°æ®
5. è‡ªåŠ¨åŒ–ç½‘é¡µäº¤äº’
6. æœåŠ¡ç«¯è‡ªåŠ¨æ¸²æŸ“

ç›®å‰å¸¸è§çš„æ— å¤´æµè§ˆå™¨æœ‰å¦‚ä¸‹å‡ ç§

1. [Selenium](https://www.selenium.dev/)
2. [puppeteer](https://pptr.dev/)
3. PhantomJS

PhantomJS 2018 å¹´ä¹‹åå¼€å§‹å°±ä¸åœ¨ç»´æŠ¤äº†ï¼Œæ‰€ä»¥ç›®å‰ä¸æŠŠè¿™ä¸ªé¡¹ç›®ä½œä¸ºä½¿ç”¨æ— å¤´æµè§ˆå™¨çš„é¦–é€‰é¡¹ç›®

## æ— å¤´æµè§ˆå™¨æ¶æ„

è¿™é‡Œ puppeteer å®˜æ–¹æä¾›çš„æ¶æ„å›¾ï¼Œå¯ä»¥çœ‹åˆ° puppeteer çš„æ–¹æ¡ˆæ˜¯é€šè¿‡ Chrome DevTool Protocol ä½œä¸ºé€šè®¯ä¸­é—´å±‚å’Œ Chrome çš„æ— å¤´æ¨¡å¼è¿›è¡Œäº¤äº’çš„ï¼Œå…¶ä½™éƒ¨åˆ†å’Œæˆ‘ä»¬æ­£å¸¸çš„ Chrome æµè§ˆå™¨å¤§åŒå°å¼‚ã€‚

- å…¶ä¸­ puppeteer å®ç°äº†åŒæ—¶æ§åˆ¶å¤šä¸ªæµè§ˆä¼šè¯å¹¶å¯æ‹¥æœ‰å¤šä¸ªé¡µé¢ï¼ˆBroswerContextï¼‰ã€‚
- Page è‡³å°‘åŒ…å« 1 ä¸ªä¸»æ¡†æ¶ï¼Œå¯èƒ½è¿˜å¯ä»¥ç”± iframe æˆ–è€…\<frame\>æ ‡ç­¾ç”Ÿæˆã€‚
- Frame è‡³å°‘æœ‰ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå³æ¡†æ¶çš„ JavaScript è¢«æ‰§è¡Œã€‚ä¸€ä¸ªæ¡†æ¶å¯èƒ½æœ‰é¢å¤–çš„ extension æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚
- Worker åªæœ‰å•ä¸€çš„æ‰§è¡Œä¸Šä¸‹æ–‡

![40333229-5df5480c-5d0c-11e8-83cb-c3e371de7374](https://github.com/moyui/BlogPosts/assets/20638429/955b92bf-5904-4bba-aa9d-e153902f776b)

### æ— å¤´æµè§ˆå™¨ä½¿ç”¨

puppeteer ç”±äºæ˜¯é€šè¿‡ node å¯åŠ¨ï¼Œç›¸å¯¹æ¥è¯´å¯¹ä¸å‰ç«¯å·¥ç¨‹å¸ˆæ›´ä¸ºå‹å¥½ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚Selenium å¯¹äºä¸‰æ–¹/æµ‹è¯•åŒå­¦æ¥è¯´æ›´ä¸ºå¸¸è§ï¼Œä¾¿äºä¹‹åæ¼”ç¤ºï¼Œæˆ‘ä»¬ç”¨ Seleniumï¼Œä¸ python è¯­è¨€è¿›è¡Œä¸¾ä¾‹ã€‚

1. python ç‰ˆæœ¬
   python2 ä¸ python3 ä¹‹é—´è·¨åº¦æ¯”è¾ƒå¤§ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨ python3 æ¥ä¸¾ä¾‹ã€‚

```shell
python3 -v

Python 3.8.9 (default, Aug 21 2021, 15:53:23)
```

2. å®‰è£… Selenium

ä¸ package.json ç±»ä¼¼ï¼Œpython é‡Œé¢æ˜¯é€šè¿‡ requirements.txt æ–‡ä»¶ä½œä¸ºç‰ˆæœ¬æ§åˆ¶

```
selenium==4.14.0
```

ç„¶åæˆ‘ä»¬æ‰§è¡Œ

```
pip3 install
```

3. demo ä¾‹å­

è¿™é‡Œ selenium å®˜æ–¹æ–‡æ¡£æœ‰ä¸€ä¸ªæ¯”è¾ƒåŸºç¡€çš„[ä¾‹å­](https://github.com/SeleniumHQ/seleniumhq.github.io/blob/trunk/examples/python/tests/getting_started/first_script.py) æˆ‘ä»¬è¿›è¡Œä¸‹ç›¸å…³ä¿®æ”¹

```python
import time
from selenium import webdriver
from selenium.webdriver.common.by import By

driver = webdriver.Chrome()

driver.get("https://www.selenium.dev/selenium/web/web-form.html")

title = driver.title

driver.implicitly_wait(0.5)

text_box = driver.find_element(by=By.NAME, value="my-text")
submit_button = driver.find_element(by=By.CSS_SELECTOR, value="button")

text_box.send_keys("Selenium")
submit_button.click()

# message = driver.find_element(by=By.ID, value="message")
# text = message.text
time.sleep(1000000)
```

æ‰§è¡Œï¼š python3 main.py

æˆ‘ä»¬ç®€å•åˆ†æä¸‹è¿™æ®µ python ä»£ç ï¼Œä»–åšäº†å¦‚ä¸‹ 3 ä»¶äº‹

1. driver = webdriver.Chrome() init ä¸€ä¸ª chrome é©±åŠ¨
2. driver.get("https://www.selenium.dev/selenium/web/web-form.html") é€šè¿‡ driver æ‰“å¼€äº†ä¸€ä¸ªé¡µé¢
3. ä¿®æ”¹ title, æ‰¾åˆ°é¡µé¢å…ƒç´ ä¹‹åä¿®æ”¹å†…å®¹ï¼Œæ‰§è¡Œ submit

æ‰§è¡Œç»“æœå¦‚ä¸‹

åŸæ¥çš„ç•Œé¢æ˜¯è¿™ä¸ªæ ·å­çš„

<img width="1100" alt="WX20231113-113901@2x" src="https://github.com/moyui/BlogPosts/assets/20638429/af55c81d-efae-4c86-9cfb-4cd0d74c1901">


è‡ªåŠ¨æäº¤åçš„ç•Œé¢æ˜¯è¿™ä¸ªæ ·å­çš„

<img width="1200" alt="WX20231113-113841@2x" src="https://github.com/moyui/BlogPosts/assets/20638429/e9c78a38-4538-4af3-97d9-9c8c71d8b742">


å¯ä»¥çœ‹åˆ°è‡ªåŠ¨æ‰§è¡Œäº†ä¸€äº›å‡½æ•°

### ä¸‰æ–¹ä¸æ— å¤´æµè§ˆå™¨

1. æ— å¤´æµè§ˆå™¨çš„ç‰¹å¾

æˆ–å¤šæˆ–å°‘å¤§å®¶éƒ½å¬è¿‡ä¸‰æ–¹æ”»å‡»ã€‚ä¸‰æ–¹æˆ–è€…å«åšé»‘äº§ä¸€èˆ¬ä½¿ç”¨æ— å¤´æµè§ˆå™¨æ¥æŠ“å–æˆ‘ä»¬çš„æ•°æ®ï¼Œæˆ–è€…é€šè¿‡æ— å¤´æµè§ˆå™¨æ¥å®ç°è‡ªåŠ¨åŒ–æ“ä½œã€‚ä½†æ˜¯å¦‚æœä¸‰æ–¹å•çº¯ä½¿ç”¨æ— å¤´æµè§ˆå™¨ï¼Œæ˜¯æ¯”è¾ƒå®¹æ˜“è¢«æ£€æµ‹å‡ºæ¥ç›¸å…³çš„ç‰¹å¾ï¼Œé™¤äº†å¤§å®¶ç†Ÿæ‚‰çš„ ua ä»¥å¤–ï¼Œè¿˜æœ‰è¿™äº›æ•°æ®

[webdriver](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/webdriver)

åœ¨ä¸€èˆ¬çš„æµè§ˆå™¨é‡Œé¢ï¼Œä»–æ˜¯è¿™ä¸ªæ ·å­

<img width="299" alt="WX20231113-115011@2x" src="https://github.com/moyui/BlogPosts/assets/20638429/5fe3c44f-c453-4c54-a3df-860cec28b06b">


è€Œåœ¨æ— å¤´æµè§ˆå™¨é‡Œé¢ï¼Œæ˜¯è¿™ä¸ªæ ·å­

<img width="270" alt="WX20231113-115027@2x" src="https://github.com/moyui/BlogPosts/assets/20638429/0547aefa-21f2-499c-9678-887a0197e145">


é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€äº›å‚æ•°ï¼Œè¿™ä¸€äº›å‚æ•°éƒ½æ˜¯é’ˆå¯¹ navigator ç›¸å…³å†…å®¹è¿›è¡Œåˆ¤æ–­

2. éšè—ç‰¹å¾

æœ‰çŸ›æ‰æœ‰ç›¾ï¼Œé’ˆå¯¹æ— å¤´æµè§ˆå™¨çš„å‡ ä¸ªç‰¹å¾ç‚¹ï¼Œæœ‰ç›¸å…³çš„è¦†ç›– js è¢«å¼€å‘å‡ºæ¥ç”¨æ¥éšè—è¿™äº›ç‰¹å¾ï¼Œç›®å‰å¤§èŒƒå›´åœ¨ä½¿ç”¨çš„æ˜¯ puppeteer ä¸­çš„ä¸€ä¸ªç¬¬ä¸‰æ–¹ç»´æŠ¤çš„æ’ä»¶ï¼š puppeteer-extra-plugin-stealth

[plugin](https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth#readme)

æˆ‘ä»¬æ¥è¯»ä¸€ä¸‹ä»–çš„æºç ï¼Œé¦–å…ˆçœ‹ä¸‹ä»–çš„æºç ç»“æ„



å…³é”®ç‚¹æˆ‘ä»¬çœ‹ä¸‹ï¼Œä¸€ä¸ªæ˜¯ pkg.jsonï¼Œ ä¸€ä¸ªæ˜¯ index.js
pkg.json

```json
{
  "name": "puppeteer-extra-plugin-stealth",
  "version": "2.11.2",
  "description": "Stealth mode: Applies various techniques to make detection of headless puppeteer harder.",
  "main": "index.js", // å…¥å£æ–‡ä»¶
  "typings": "index.d.ts",
  "repository": "berstend/puppeteer-extra",
  "homepage": "https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth#readme",
  "author": "berstend",
  "license": "MIT",
  "scripts": {
    "docs": "run-s docs-for-plugin postdocs-for-plugin docs-for-evasions postdocs-for-evasions types",
    "docs-for-plugin": "documentation readme --quiet --shallow --github --markdown-theme transitivebs --readme-file readme.md --section API index.js",
    "postdocs-for-plugin": "npx prettier --write readme.md",
    "docs-for-evasions": "cd ./evasions && loop \"documentation readme --quiet --shallow --github --markdown-theme transitivebs --readme-file readme.md --section API index.js\"",
    "postdocs-for-evasions": "cd ./evasions && loop \"npx prettier --write readme.md\"",
    "lint": "eslint --ext .js .",
    "test:js": "ava --concurrency 2 -v",
    "test": "run-p test:js",
    "test-ci": "run-s test:js",
    "types": "npx --package typescript@3.7 tsc --emitDeclarationOnly --declaration --allowJs index.js"
  },
  "engines": {
    "node": ">=8"
  },
  "keywords": [
    "puppeteer",
    "puppeteer-extra",
    "puppeteer-extra-plugin",
    "stealth",
    "stealth-mode",
    "detection-evasion",
    "crawler",
    "chrome",
    "headless",
    "pupeteer"
  ],
  "ava": {
    "files": ["!test/util.js", "!test/fixtures/sw.js"]
  },
  "devDependencies": {
    "ava": "2.4.0",
    "documentation-markdown-themes": "^12.1.5",
    "fpcollect": "^1.0.4",
    "fpscanner": "^0.1.5",
    "loop": "^3.0.6",
    "npm-run-all": "^4.1.5",
    "puppeteer": "9"
  },
  "dependencies": {
    "debug": "^4.1.1",
    "puppeteer-extra-plugin": "^3.2.3",
    "puppeteer-extra-plugin-user-preferences": "^2.4.1"
  },
  "peerDependencies": {
    "playwright-extra": "*",
    "puppeteer-extra": "*"
  },
  "peerDependenciesMeta": {
    "puppeteer-extra": {
      "optional": true
    },
    "playwright-extra": {
      "optional": true
    }
  },
  "gitHead": "babb041828cab50c525e0b9aab02d58f73416ef3"
}
```

æˆ‘ä»¬çœ‹ä¸‹ index.js

```javascript
class StealthPlugin extends PuppeteerExtraPlugin {
  constructor(opts = {}) {
    super(opts);
  }

  get name() {
    return "stealth";
  }

  get defaults() {
    const availableEvasions = new Set([
      "chrome.app", // chromeçš„ç§æœ‰å±æ€§
      "chrome.csi",
      "chrome.loadTimes",
      "chrome.runtime",
      "defaultArgs", // é»˜è®¤å‚æ•°
      "iframe.contentWindow", // srcdocç›¸å…³å‚æ•°
      "media.codecs", // åª’ä½“ç±»å‹   * video/webm; codecs="vp8, vorbis" * video/mp4; codecs="avc1.42E01E" * audio/x-m4a; * audio/ogg; codecs="vorbis"
      "navigator.hardwareConcurrency", // å¤„ç†å™¨æ ¸æ•°
      "navigator.languages", // è¯­è¨€
      "navigator.permissions", // æƒé™
      "navigator.plugins", // é»˜è®¤æ’ä»¶
      "navigator.webdriver",
      "sourceurl", // CDPSession å’Œ chrome devtoolsé€šä¿¡çš„åè®®
      "user-agent-override", // ua
      "webgl.vendor", // webgl çš„æ¸²æŸ“å™¨
      "window.outerdimensions", // å±å¹•å°ºå¯¸
    ]);
    return {
      availableEvasions,
      enabledEvasions: new Set([...availableEvasions]),
    };
  }

  get dependencies() {
    return new Set(
      [...this.opts.enabledEvasions].map((e) => `${this.name}/evasions/${e}`)
    );
  }

  get availableEvasions() {
    return this.defaults.availableEvasions;
  }

  get enabledEvasions() {
    return this.opts.enabledEvasions;
  }

  /**
   * @private
   */
  set enabledEvasions(evasions) {
    this.opts.enabledEvasions = evasions;
  }

  async onBrowser(browser) {
    if (browser && browser.setMaxListeners) {
      browser.setMaxListeners(30);
    }
  }
}

const defaultExport = (opts) => new StealthPlugin(opts);
module.exports = defaultExport;
```

å¯ä»¥çœ‹åˆ°ç›´æ¥ç”¨äº†ä¸€ä¸ª set æ¥å­˜æ”¾æ‰€æœ‰çš„ä¿®æ”¹ä»£ç ï¼Œè¿™ä¸ªé€»è¾‘åœ¨ evasions é‡Œé¢ï¼Œæ¥ä¸‹æ¥æˆ‘æŠŠå…³é”®ä»£ç ä¸¾ä¾‹

```javascript
// chrome.app
if (!window.chrome) {
  Object.defineProperty(window, "chrome", {
    writable: true,
    enumerable: true,
    configurable: false, // note!
    value: {}, // We'll extend that later
  });
}

if ("app" in window.chrome) {
  return;
}

const makeError = {
  ErrorInInvocation: (fn) => {
    const err = new TypeError(`Error in invocation of app.${fn}()`);
    return utils.stripErrorWithAnchor(err, `at ${fn} (eval at <anonymous>`);
  },
};

const STATIC_DATA = JSON.parse(
  `
{
  "isInstalled": false,
  "InstallState": {
    "DISABLED": "disabled",
    "INSTALLED": "installed",
    "NOT_INSTALLED": "not_installed"
  },
  "RunningState": {
    "CANNOT_RUN": "cannot_run",
    "READY_TO_RUN": "ready_to_run",
    "RUNNING": "running"
  }
}
        `.trim()
);

window.chrome.app = {
  ...STATIC_DATA,

  get isInstalled() {
    return false;
  },

  getDetails: function getDetails() {
    if (arguments.length) {
      throw makeError.ErrorInInvocation(`getDetails`);
    }
    return null;
  },
  getIsInstalled: function getDetails() {
    if (arguments.length) {
      throw makeError.ErrorInInvocation(`getIsInstalled`);
    }
    return false;
  },
  runningState: function getDetails() {
    if (arguments.length) {
      throw makeError.ErrorInInvocation(`runningState`);
    }
    return "cannot_run";
  },
};
```

åé¢çš„ä»£ç åˆ¤æ–­å‚æ•°æ˜¯å¦æœ‰æ— å°±ä¸åˆ—ä¸¾äº†

```javascript
// chrome.csi
const { timing } = window.performance;

window.chrome.csi = function () {
  return {
    onloadT: timing.domContentLoadedEventEnd,
    startE: timing.navigationStart,
    pageT: Date.now() - timing.navigationStart,
    tran: 15, // Transition type or something
  };
};
```

```javascript
// chrome.loadTims
const ntEntryFallback = {
  nextHopProtocol: "h2",
  type: "other",
};

const protocolInfo = {
  get connectionInfo() {
    const ntEntry =
      performance.getEntriesByType("navigation")[0] || ntEntryFallback;
    return ntEntry.nextHopProtocol;
  },
  get npnNegotiatedProtocol() {
    const ntEntry =
      performance.getEntriesByType("navigation")[0] || ntEntryFallback;
    return ["h2", "hq"].includes(ntEntry.nextHopProtocol)
      ? ntEntry.nextHopProtocol
      : "unknown";
  },
  get navigationType() {
    const ntEntry =
      performance.getEntriesByType("navigation")[0] || ntEntryFallback;
    return ntEntry.type;
  },
  get wasAlternateProtocolAvailable() {
    return false;
  },
  get wasFetchedViaSpdy() {
    const ntEntry =
      performance.getEntriesByType("navigation")[0] || ntEntryFallback;
    return ["h2", "hq"].includes(ntEntry.nextHopProtocol);
  },
  get wasNpnNegotiated() {
    const ntEntry =
      performance.getEntriesByType("navigation")[0] || ntEntryFallback;
    return ["h2", "hq"].includes(ntEntry.nextHopProtocol);
  },
};

const { timing } = window.performance;

function toFixed(num, fixed) {
  var re = new RegExp("^-?\\d+(?:.\\d{0," + (fixed || -1) + "})?");
  return num.toString().match(re)[0];
}

const timingInfo = {
  get firstPaintAfterLoadTime() {
    return 0;
  },
  get requestTime() {
    return timing.navigationStart / 1000;
  },
  get startLoadTime() {
    return timing.navigationStart / 1000;
  },
  get commitLoadTime() {
    return timing.responseStart / 1000;
  },
  get finishDocumentLoadTime() {
    return timing.domContentLoadedEventEnd / 1000;
  },
  get finishLoadTime() {
    return timing.loadEventEnd / 1000;
  },
  get firstPaintTime() {
    const fpEntry = performance.getEntriesByType("paint")[0] || {
      startTime: timing.loadEventEnd / 1000,
    };
    return toFixed((fpEntry.startTime + performance.timeOrigin) / 1000, 3);
  },
};

window.chrome.loadTimes = function () {
  return {
    ...protocolInfo,
    ...timingInfo,
  };
};
```

å…¶ä»–éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œå°±ä¸ä¸¾ä¾‹äº†ï¼Œæˆ‘ä»¬çœ‹ä¸‹ webdriver
è¿™é‡Œæœ‰ç‚¹ä¸å¤ªä¸€æ ·

```javascript
  async onPageCreated(page) {
    await page.evaluateOnNewDocument(() => {
      if (navigator.webdriver === false) {
      } else if (navigator.webdriver === undefined) {
      } else {
        delete Object.getPrototypeOf(navigator).webdriver
      }
    })
  }

  async beforeLaunch(options) {
    const idx = options.args.findIndex((arg) => arg.startsWith('--disable-blink-features='));
    if (idx !== -1) {
      const arg = options.args[idx];
      options.args[idx] = `${arg},AutomationControlled`;
    } else {
      options.args.push('--disable-blink-features=AutomationControlled');
    }
  }
```

3. æ— å¤´æµè§ˆå™¨æŒ‚è½½ éšèº« å‡½æ•°

é€šè¿‡è¿™ä¸ªç½‘ç«™ä¸‹è½½åˆ°æœ¬åœ°
https://raw.githubusercontent.com/requireCool/stealth.min.js/main/stealth.min.js

ç„¶å python è„šæœ¬å¦‚ä¸‹

```python
import time
from selenium import webdriver
from selenium.webdriver.chrome.options import Options

chrome_options = Options()
chrome_options.add_argument("--proxy-server=127.0.0.1:8888")
global browser
browser = webdriver.Chrome(chrome_options)
with open('stealth.min.js', 'r') as f:
    js = f.read()
browser.execute_cdp_cmd('Page.addScriptToEvaluateOnNewDocument', { 'source': js })
browser.get("http://www.baidu.com")
time.sleep(1000000)
```

ç„¶åæˆ‘ä»¬å¯åŠ¨ï¼Œä¼šå‘ç°é¡µé¢ä»£ç†åˆ°äº†æœ¬åœ°çš„ä»£ç†å·¥å…·ï¼ˆ"--proxy-server=127.0.0.1:8888"ï¼‰
ç„¶åæˆ‘ä»¬çœ‹ä¸‹ webdriver æ˜¯å¦æ³¨å…¥æˆåŠŸ

<img width="547" alt="WX20231113-152141@2x" src="https://github.com/moyui/BlogPosts/assets/20638429/9ba73e90-5cf6-47dd-9f39-85a53e5be484">


ç›´æ¥ç»™å¼„æˆ undefined çš„äº†

ä»£ç†ä¹Ÿä»£ç†ä¸Šäº†

<img width="395" alt="proxy" src="https://github.com/moyui/BlogPosts/assets/20638429/00f09815-9675-4f01-bddb-de133d8225a7">


### æ”»é˜²

å…¶å®è¿™ä¸€å—æ˜¯éå¸¸éš¾å†™çš„ï¼Œæˆ‘è¿™é‡Œç»™å‡ºç»“è®ºï¼Œç›®å‰ç°åœ¨æ‰€æœ‰å¼€æºçš„è¯†åˆ«æ— å¤´æµè§ˆå™¨çš„æ–¹æ¡ˆå…¨éƒ¨éƒ½æ— æ•ˆ
æ¯”å¦‚ä»¥ä¸‹å‡ ä¸ªé¡¹ç›®

https://infosimples.github.io/detect-headless/

https://bot.sannysoft.com/

https://github.com/antoinevastel/fpscanner/blob/master/src/fpScanner.js

è¿™äº›éƒ½æ˜¯ star æ¯”è¾ƒå¤šçš„ï¼Œå…¨éƒ¨éƒ½å¤±å»æ•ˆæœäº†

ç›®å‰çš„ä¸»æµåšæ³•éƒ½æ˜¯éœ€è¦å€ŸåŠ©ç®—æ³•ï¼Œæ¯”å¦‚ç”¨æˆ·è¡Œä¸ºæ“ä½œï¼ˆé¼ æ ‡ï¼Œé”®ç›˜äº‹ä»¶ç­‰ï¼‰ï¼Œç„¶åé…åˆ ua ç­‰ä¸€äº›å­—æ®µä¸ŠæŠ¥æ¥è®¡ç®—

## è®¾å¤‡æŒ‡çº¹

ä¹‹å‰æˆ‘ä»¬æœ‰åŒå­¦éœ€è¦åˆ¤æ–­å”¯ä¸€æ€§ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°è®¾å¤‡æŒ‡çº¹

ä½†æ˜¯æœ¬è´¨ä¸Šæ— å¤´æµè§ˆå™¨çš„æ£€æµ‹å’Œè®¾å¤‡æŒ‡çº¹æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯æ£€æµ‹æµè§ˆå™¨çš„ç‰¹å¾

è¿™ä¸ªåº“æ˜¯æ¯”è¾ƒæœ‰åçš„ https://github.com/fingerprintjs/fingerprintjs

å…·ä½“åŸç†æ˜¯æŠŠå„ä¸ªéƒ¨åˆ†å½“æˆç»„ä»¶åˆ†åˆ«å®ç°ï¼Œç„¶åä½¿ç”¨ loadBuiltinSources æ–¹æ³•è·å–æ‰€æœ‰ç»„ä»¶ï¼Œæ¥ç€ä½¿ç”¨ componentsToCanonicalString éå†ç»„ä»¶çš„è¿”å›å€¼ï¼Œç³»åˆ—åŒ–æ‹¼æ¥æˆå­—ç¬¦ä¸²ï¼Œæœ€åç”¨ x64hash128 æ–¹æ³•æŠŠå­—ç¬¦ä¸²è½¬æˆä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ hash å€¼ã€‚

è¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸‹æœ‰å“ªäº›æ˜¯æµè§ˆå™¨ç‰¹å¾

```javascript
var components = [
  { key: "userAgent", getData: UserAgent }, //ç”¨æˆ·ä»£ç†
  { key: "webdriver", getData: webdriver }, //ç½‘é¡µå†…é©±åŠ¨è½¯ä»¶
  { key: "language", getData: languageKey }, //è¯­è¨€ç§ç±»
  { key: "colorDepth", getData: colorDepthKey }, //ç›®æ ‡è®¾å¤‡æˆ–ç¼“å†²å™¨ä¸Šçš„è°ƒè‰²æ¿çš„æ¯”ç‰¹æ·±åº¦
  { key: "deviceMemory", getData: deviceMemoryKey }, //è®¾å¤‡å†…å­˜
  { key: "pixelRatio", getData: pixelRatioKey }, //è®¾å¤‡åƒç´ æ¯”
  { key: "hardwareConcurrency", getData: hardwareConcurrencyKey }, //å¯ç”¨äºè¿è¡Œåœ¨ç”¨æˆ·çš„è®¡ç®—æœºä¸Šçš„çº¿ç¨‹çš„é€»è¾‘å¤„ç†å™¨çš„æ•°é‡ã€‚
  { key: "screenResolution", getData: screenResolutionKey }, //å½“å‰å±å¹•åˆ†è¾¨ç‡
  { key: "availableScreenResolution", getData: availableScreenResolutionKey }, //å±å¹•å®½é«˜ï¼ˆç©ºç™½ç©ºé—´ï¼‰
  { key: "timezoneOffset", getData: timezoneOffset }, //æœ¬åœ°æ—¶é—´ä¸ GMT æ—¶é—´ä¹‹é—´çš„æ—¶é—´å·®ï¼Œä»¥åˆ†é’Ÿä¸ºå•ä½
  { key: "timezone", getData: timezone }, //æ—¶åŒº
  { key: "sessionStorage", getData: sessionStorageKey }, //æ˜¯å¦ä¼šè¯å­˜å‚¨
  { key: "localStorage", getData: localStorageKey }, //æ˜¯å¦å…·æœ‰æœ¬åœ°å­˜å‚¨
  { key: "indexedDb", getData: indexedDbKey }, //æ˜¯å¦å…·æœ‰ç´¢å¼•DB
  { key: "addBehavior", getData: addBehaviorKey }, //IEæ˜¯å¦æŒ‡å®šAddBehavior
  { key: "openDatabase", getData: openDatabaseKey }, //æ˜¯å¦æœ‰æ‰“å¼€çš„DB
  { key: "cpuClass", getData: cpuClassKey }, //æµè§ˆå™¨ç³»ç»Ÿçš„CPUç­‰çº§
  { key: "platform", getData: platformKey }, //è¿è¡Œæµè§ˆå™¨çš„æ“ä½œç³»ç»Ÿå’Œ(æˆ–)ç¡¬ä»¶å¹³å°
  { key: "doNotTrack", getData: doNotTrackKey }, //do-not-trackè®¾ç½®
  { key: "plugins", getData: pluginsComponent }, //æµè§ˆå™¨çš„æ’ä»¶ä¿¡æ¯
  { key: "canvas", getData: canvasKey }, //ä½¿ç”¨ Canvas ç»˜å›¾
  { key: "webgl", getData: webglKey }, //WebGLæŒ‡çº¹ä¿¡æ¯
  { key: "webglVendorAndRenderer", getData: webglVendorAndRendererKey }, //å…·æœ‰å¤§é‡ç†µçš„WebGLæŒ‡çº¹çš„å­é›†
  { key: "adBlock", getData: adBlockKey }, //æ˜¯å¦å®‰è£…AdBlock
  { key: "hasLiedLanguages", getData: hasLiedLanguagesKey }, //ç”¨æˆ·æ˜¯å¦ç¯¡æ”¹äº†è¯­è¨€
  { key: "hasLiedResolution", getData: hasLiedResolutionKey }, //ç”¨æˆ·æ˜¯å¦ç¯¡æ”¹äº†å±å¹•åˆ†è¾¨ç‡
  { key: "hasLiedOs", getData: hasLiedOsKey }, //ç”¨æˆ·æ˜¯å¦ç¯¡æ”¹äº†æ“ä½œç³»ç»Ÿ
  { key: "hasLiedBrowser", getData: hasLiedBrowserKey }, //ç”¨æˆ·æ˜¯å¦ç¯¡æ”¹äº†æµè§ˆå™¨
  { key: "touchSupport", getData: touchSupportKey }, //è§¦æ‘¸å±æ£€æµ‹å’Œèƒ½åŠ›
  { key: "fonts", getData: jsFontsKey, pauseBefore: true }, //ä½¿ç”¨JS/CSSæ£€æµ‹åˆ°çš„å­—ä½“åˆ—è¡¨
  { key: "fontsFlash", getData: flashFontsKey, pauseBefore: true }, //å·²å®‰è£…çš„Flashå­—ä½“åˆ—è¡¨
  { key: "audio", getData: audioKey }, //éŸ³é¢‘å¤„ç†
  { key: "enumerateDevices", getData: enumerateDevicesKey }, //å¯ç”¨çš„å¤šåª’ä½“è¾“å…¥å’Œè¾“å‡ºè®¾å¤‡çš„ä¿¡æ¯ã€‚
];
```

æˆ‘ä»¬çœ‹å‡ ä¸ªæœ‰æ„æ€çš„é€‰é¡¹

### canvas æŒ‡çº¹

é€šè¿‡ canvas æ¥å£åœ¨é¡µé¢ä¸Šç»˜åˆ¶ä¸€ä¸ªéšè—çš„å›¾åƒï¼Œåœ¨ä¸åŒçš„ç³»ç»Ÿï¼Œæµè§ˆå™¨ä¸­æœ€ç»ˆçš„å›¾åƒæ˜¯å­˜åœ¨åƒç´ çº§åˆ«çš„å·®åˆ«çš„ï¼Œä¸»è¦æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿå„è‡ªä½¿ç”¨äº†ä¸åŒçš„è®¾ç½®å’Œç®—æ³•æ¥è¿›è¡ŒæŠ—é”¯é½¿å’Œå­åƒç´ æ¸²æŸ“æ“ä½œã€‚å³ä½¿ç›¸åŒçš„ç»˜å›¾æ“ä½œï¼Œäº§ç”Ÿçš„å›¾ç‰‡æ•°æ®çš„ CRC æ£€éªŒä¹Ÿä¸ç›¸åŒã€‚(CRC æ˜¯æŒ‡ä½¿ç”¨ canvas.toDataURL è¿”å›çš„ base64 æ•°æ®ä¸­ï¼Œæœ€åä¸€æ®µ 32 ä½çš„éªŒè¯ç )ã€‚

canvas æŒ‡çº¹å¹¶ä¸å°‘è§ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä½¿ç”¨éŸ³é¢‘æŒ‡çº¹ï¼Œç”šè‡³ä½¿ç”¨ WebGL æŒ‡çº¹å’Œ WebGL æŒ‡çº¹çš„ã€‚ éŸ³é¢‘æŒ‡çº¹è·Ÿ canvas æŒ‡çº¹çš„åŸç†å·®ä¸å¤šï¼Œéƒ½æ˜¯åˆ©ç”¨ç¡¬ä»¶æˆ–è½¯ä»¶çš„å·®å¼‚ï¼Œå‰è€…ç”ŸæˆéŸ³é¢‘ï¼Œåè€…ç”Ÿæˆå›¾ç‰‡ï¼Œç„¶åè®¡ç®—å¾—åˆ°ä¸åŒå“ˆå¸Œå€¼æ¥ä½œä¸ºæ ‡è¯†ã€‚éŸ³é¢‘æŒ‡çº¹çš„ç”Ÿæˆæ–¹å¼æœ‰ä¸¤ç§ï¼š

1. ç”ŸæˆéŸ³é¢‘ä¿¡æ¯æµ(ä¸‰è§’æ³¢)ï¼Œå¯¹å…¶è¿›è¡Œ FFT å˜æ¢ï¼Œè®¡ç®— SHA å€¼ä½œä¸ºæŒ‡çº¹
2. ç”ŸæˆéŸ³é¢‘ä¿¡æ¯æµï¼ˆæ­£å¼¦æ³¢ï¼‰ï¼Œè¿›è¡ŒåŠ¨æ€å‹ç¼©å¤„ç†ï¼Œè®¡ç®— MD5 å€¼

è¿™é‡Œ fingerprintjs ç”¨çš„æ˜¯æ–¹æ³• 1ï¼Œèµ°å¿«é€Ÿå‚…ç«‹å¶å˜æ¢çš„æ–¹æ¡ˆï¼Œä¸å¤šèµ˜è¿°äº†

æˆ‘ä»¬çœ‹ä¸‹ canvas æŒ‡çº¹çš„ä»£ç 

```javascript
export interface CanvasFingerprint {
  winding: boolean
  geometry: string
  text: string
}

export const enum ImageStatus {
  Unsupported = 'unsupported',
  Skipped = 'skipped',
  Unstable = 'unstable',
}

// å…¥å£å‡½æ•°ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯ç¬¦åˆçš„å†…æ ¸
export default function getCanvasFingerprint(): Promise<CanvasFingerprint> {
  return getUnstableCanvasFingerprint(doesBrowserPerformAntifingerprinting())
}

export async function getUnstableCanvasFingerprint(skipImages?: boolean): Promise<CanvasFingerprint> {
  let winding = false
  let geometry: string
  let text: string

  const [canvas, context] = makeCanvasContext() // ç”Ÿæˆä¸€ä¸ª1*1çš„canvas
  if (!isSupported(canvas, context)) { // åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰todataurlæ–¹æ³•ï¼ˆè½¬base64ï¼‰
    geometry = text = ImageStatus.Unsupported
  } else {
    winding = doesSupportWinding(context) // è¿™é‡Œæ˜¯ç‰¹æ€§åˆ¤æ–­ï¼Œå¯ä»¥å…ˆä¸ç”¨ç®¡ï¼Œä¸å½±å“ç»“æœ

    if (skipImages) {
      geometry = text = ImageStatus.Skipped
    } else {
      ;[geometry, text] = await renderImages(canvas, context) // imageæµ‹è¯•
    }
  }

  return { winding, geometry, text }
}

function makeCanvasContext() {
  const canvas = document.createElement('canvas')
  canvas.width = 1
  canvas.height = 1
  return [canvas, canvas.getContext('2d')] as const
}

function isSupported(
  canvas: HTMLCanvasElement,
  context?: CanvasRenderingContext2D | null,
): context is CanvasRenderingContext2D {
  return !!(context && canvas.toDataURL)
}

function doesSupportWinding(context: CanvasRenderingContext2D) {
  context.rect(0, 0, 10, 10)
  context.rect(2, 2, 6, 6)
  return !context.isPointInPath(5, 5, 'evenodd')
}

async function renderImages(
  canvas: HTMLCanvasElement,
  context: CanvasRenderingContext2D,
): Promise<[geometry: string, text: string]> {
  renderTextImage(canvas, context) // æ¸²æŸ“ä¸€äº›æ–‡å­—å’Œemoji
  await releaseEventLoop()
  const textImage1 = canvasToString(canvas)
  const textImage2 = canvasToString(canvas)
  if (textImage1 !== textImage2) {
    return [ImageStatus.Unstable, ImageStatus.Unstable] // ä¸¤æ¬¡canvasçš„ç»“æœä¸ç¨³å®š
  }

  renderGeometryImage(canvas, context) // è¿™é‡Œæ˜¯ç”»å‡ ä½•å›¾å½¢
  await releaseEventLoop()
  const geometryImage = canvasToString(canvas)
  return [textImage1, geometryImage]
}

function renderTextImage(canvas: HTMLCanvasElement, context: CanvasRenderingContext2D) {
  canvas.width = 240
  canvas.height = 60

  context.textBaseline = 'alphabetic'
  context.fillStyle = '#f60'
  context.fillRect(100, 1, 62, 20)

  context.fillStyle = '#069'
  context.font = '11pt "Times New Roman"'
  const printedText = `Cwm fjordbank gly ${String.fromCharCode(55357, 56835) /* ğŸ˜ƒ */}`
  context.fillText(printedText, 2, 15)
  context.fillStyle = 'rgba(102, 204, 0, 0.2)'
  context.font = '18pt Arial'
  context.fillText(printedText, 4, 45)
}

function renderGeometryImage(canvas: HTMLCanvasElement, context: CanvasRenderingContext2D) {
  canvas.width = 122
  canvas.height = 110

  context.globalCompositeOperation = 'multiply'
  for (const [color, x, y] of [
    ['#f2f', 40, 40],
    ['#2ff', 80, 40],
    ['#ff2', 60, 80],
  ] as const) {
    context.fillStyle = color
    context.beginPath()
    context.arc(x, y, 40, 0, Math.PI * 2, true)
    context.closePath()
    context.fill()
  }

  context.fillStyle = '#f9c'
  context.arc(60, 60, 60, 0, Math.PI * 2, true)
  context.arc(60, 60, 20, 0, Math.PI * 2, true)
  context.fill('evenodd')
}

function canvasToString(canvas: HTMLCanvasElement) {
  return canvas.toDataURL()
}

function doesBrowserPerformAntifingerprinting() {
  return isWebKit() && isWebKit616OrNewer() && isSafariWebKit()
}
```

### é€šè¿‡ç³»ç»Ÿå­—ä½“

åŸç†æ˜¯åˆ¤æ–­æµè§ˆå™¨/æ“ä½œç³»ç»Ÿå¯¹å­—ä½“çš„æ”¯æŒç¨‹åº¦ï¼Œä»£ç å¦‚ä¸‹

```javascript
const testString = 'mmMwWLliI0O&1'

const textSize = '48px'

const baseFonts = ['monospace', 'sans-serif', 'serif'] as const

const fontList = [
  'sans-serif-thin',
  'ARNO PRO',
  'Agency FB',
  'Arabic Typesetting',
  'Arial Unicode MS',
  'AvantGarde Bk BT',
  'BankGothic Md BT',
  'Batang',
  'Bitstream Vera Sans Mono',
  'Calibri',
  'Century',
  'Century Gothic',
  'Clarendon',
    // è¿˜æœ‰ä¸€å¤§å †ï¼Œä¸ºäº†å±•ç¤ºé•¿åº¦å°±ä¸åˆ—ä¸¾äº†
] as const


export default function getFonts(): Promise<string[]> {
  return withIframe(async (_, { document }) => {
    const holder = document.body
    holder.style.fontSize = textSize

    const spansContainer = document.createElement('div')
    spansContainer.style.setProperty('visibility', 'hidden', 'important') // æ•´ä¸ªéšè—div

    const defaultWidth: Partial<Record<string, number>> = {}
    const defaultHeight: Partial<Record<string, number>> = {}

    const createSpan = (fontFamily: string) => {
      const span = document.createElement('span')
      const { style } = span
      style.position = 'absolute'
      style.top = '0'
      style.left = '0'
      style.fontFamily = fontFamily
      span.textContent = testString
      spansContainer.appendChild(span)
      return span
    }

    // åˆ†åˆ«éå†baseFontså’ŒfontListï¼Œç”Ÿæˆspanæ ‡ç­¾ï¼Œå¹¶è®¾ç½®å¯¹åº”çš„fontFamilyï¼Œæ³¨æ„fontListéå†çš„æ—¶å€™ï¼Œéœ€è¦åŒæ—¶éå†baseFontsï¼Œè¿™æ ·è®¾ç½®fontFamilyçš„æ—¶å€™å¯ä»¥è®¾ç½®é»˜è®¤çš„baseFontså­—ä½“
    const createSpanWithFonts = (fontToDetect: string, baseFont: string) => {
      return createSpan(`'${fontToDetect}',${baseFont}`)
    }

    const initializeBaseFontsSpans = () => {
      return baseFonts.map(createSpan)
    }

    const initializeFontsSpans = () => {
      const spans: Record<string, HTMLSpanElement[]> = {}

      for (const font of fontList) {
        spans[font] = baseFonts.map((baseFont) => createSpanWithFonts(font, baseFont))
      }

      return spans
    }

    // æ¯”è¾ƒfontListå’ŒbaseFontsçš„å­—ä½“æ–‡æ¡ˆåœ¨ä¸åŒçš„fontFamilyä¸‹çš„å®½é«˜ï¼Œå¦‚æœä¸ç›¸ç­‰è¯´æ˜æ”¯æŒè¯¥å­—ä½“ï¼Œå¦‚æœç›¸ç­‰ï¼Œè¯´æ˜ç³»ç»Ÿä¸æ”¯æŒfontListçš„å­—ä½“ï¼Œä½¿ç”¨äº†é»˜è®¤çš„baseFontsçš„å­—ä½“
    const isFontAvailable = (fontSpans: HTMLElement[]) => {
      return baseFonts.some(
        (baseFont, baseFontIndex) =>
          fontSpans[baseFontIndex].offsetWidth !== defaultWidth[baseFont] ||
          fontSpans[baseFontIndex].offsetHeight !== defaultHeight[baseFont],
      )
    }

    const baseFontsSpans = initializeBaseFontsSpans()

    const fontsSpans = initializeFontsSpans()

    holder.appendChild(spansContainer)

    await releaseEventLoop()

    for (let index = 0; index < baseFonts.length; index++) {
      defaultWidth[baseFonts[index]] = baseFontsSpans[index].offsetWidth
      defaultHeight[baseFonts[index]] = baseFontsSpans[index].offsetHeight
    }

    // å¯¹æ¯”
    return fontList.filter((font) => isFontAvailable(fontsSpans[font]))
  })
}



```

### MurmurHash3

æœ€åç®€å•ä»‹ç»ä¸€ä¸‹ hash å‡½æ•°ï¼Œç”¨çš„æ˜¯ MurmurHash ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•

MurmurHash æ˜¯ä¸€ç§ç»è¿‡å¹¿æ³›æµ‹è¯•ä¸”é€Ÿåº¦å¾ˆå¿«çš„éåŠ å¯†å“ˆå¸Œå‡½æ•°ã€‚å®ƒæœ‰ Austin Appleby äº 2008 å¹´åˆ›å»ºï¼Œå¹¶å­˜åœ¨å¤šç§å˜ä½“ï¼Œåå­—æ¥è‡ªä¸¤ä¸ªåŸºæœ¬è¿ç®—ï¼Œå³ multiply(ä¹˜æ³•)å’Œ rotate(æ—‹è½¬)ï¼ˆå°½ç®¡è¯¥ç®—æ³•å®é™…ä¸Šä½¿ç”¨ shift å’Œ xor è€Œä¸æ˜¯ rotateï¼‰ã€‚æœ€ç»ˆäº§ç”Ÿ 32 ä½æˆ– 128 ä½å“ˆå¸Œï¼Œ

https://blog.csdn.net/qq_44932835/article/details/122292320

## mac åœ°å€

mac åœ°å€ç†è®ºä¸Šæ˜¯ç¡¬ä»¶åœ°å€ï¼Œæ˜¯å”¯ä¸€çš„ï¼Œè™½ç„¶è¿˜æ˜¯ä¼šè¢«äººå·¥ä¿®æ”¹

åœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹åªæœ‰ ie èƒ½å¤Ÿè·å–åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¸å¤šé˜è¿°äº†

## æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†æ— å¤´æµè§ˆå™¨çš„ä½¿ç”¨å’Œæµè§ˆå™¨çš„ç›¸å…³ç‰¹å¾ï¼Œå¸Œæœ›ä»¥ååŒå­¦ä»¬é‡åˆ°æœ‰å…³çš„éœ€æ±‚çš„æ—¶å€™èƒ½æƒ³çš„èµ·æ¥ã€‚
